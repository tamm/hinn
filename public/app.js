angular.module("Hinn",["ngMaterial","ngMdIcons","oauth2","angularMoment"]).config(["OAuthProvider",function(e){e.configure({baseUrl:"https://api.vasttrafik.se:443",clientId:"Hinn Med",clientKey:"9L4HY9Ofdsg4Q4JIbXY_2ugqVr8a",clientSecret:"NtG5cvDFKasC1NyDtGl9boyRfMYa",grantPath:"/token"})}]).run(["$rootScope","$window","OAuth",function(e,t,n){e.$on("oauth:error",function(e,t){if(console.log("caught an error",t),"invalid_grant"!==t.data.error)return"invalid_token"===t.data.error?(console.log("invalid_token"),n.getRefreshToken()):void 0})}]).controller("HinnController",["$rootScope","$scope","$http","OAuth","OAuthToken","$mdDialog","$interval","$timeout",function(e,t,n,o,r,a,i,s){var c,l="https://api.vasttrafik.se/bin/rest.exe/v2",u=(o.isAuthenticated(),2),d={};d.recentLocations="hinn.recentLocations",t.recentLocations=JSON.parse(sessionStorage.getItem(d.recentLocations))||[];var g=function(e,t,n){for(var o=0;o<e.length;o+=1)if(e[o][t]&&e[o][t]===n)return o;return-1};t.loading=!0,t.title="Hinn",t.$watch("NearbyStops",function(e){if(e){var n=[];e.LocationList.StopLocation.forEach(function(e){e.hasOwnProperty("track")||n.push(e)}),t.nearbystops=n}}),t.$watch("trips",function(e){if(e){var n=[];e.forEach(function(e){Array.isArray(e.Leg)||(e.Leg=[e.Leg]),n=n.concat(e.Leg)}),t.legs=n,v(t.departureBoard)}}),navigator.geolocation.getCurrentPosition(function(e){t.location=e,p()});var p=function(){var e=l+"/location.nearbystops";params={format:"json",originCoordLong:t.location.coords.longitude,originCoordLat:t.location.coords.latitude,maxNo:25},n.get(e,{params:params}).then(function(e){t.NearbyStops=e.data,console.log("nearbystops",t.NearbyStops),t.loading=!1})},m=function(){console.log("handleToken"),t.token=o.getAccessToken(),t.token.then(function(e){refreshTime=e.expiresAt-(new Date).getTime()-100,s(m,refreshTime)})};t.token=o.getAccessToken(),t.token.then(function(e){refreshTime=e.expiresAt-(new Date).getTime()-100,s(m,refreshTime)}),t.people=[{name:"tamm"},{name:"tamm2"}];var f=function(){var e=l+"/systeminfo";params={format:"json"},n.get(e,{params:params}).then(function(e){e&&e.data&&e.data.SystemInfo&&(t.SystemInfo=e.data.SystemInfo),console.log("systemInfo",e.data.SystemInfo)})};t.showInfo=function(e){console.log("showInfo"),f(),a.show({controller:"HinnController",templateUrl:"showInfoDialog.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:t.customFullscreen})},t.openSelectDestination=function(e){console.log("openSelectDestination"),a.show({controller:"HinnController",templateUrl:"selectDestination.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:!0})},t.openSelectOrigin=function(e){console.log("openSelectOrigin"),a.show({controller:"HinnController",templateUrl:"selectOrigin.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:!0})},t.selectOrigin=function(n){console.log("selectOrigin"),e.origin=n,L(),c=i(L,6e4),t.loading=!0,h(n),a.hide()},t.removeOrigin=function(){console.log("removeOrigin"),e.origin=!1,t.departureBoard=!1,i.cancel(c)},t.selectDeparture=function(e){console.log("selectDeparture"),t.departure=e.departures[0]},t.removeDeparture=function(){console.log("removeDeparture"),t.departure=!1},t.searchLocations=function(e){t.loading=!0,D()},t.closeDialog=function(){a.hide()};var h=function(e){console.log("saveRecentLocation"),t.recentLocations=JSON.parse(sessionStorage.getItem(d.recentLocations))||[],t.recentLocations.forEach(function(n,o){n&&n.id===e.id&&t.recentLocations.splice(o,1)}),t.recentLocations.unshift(e),t.recentLocations=t.recentLocations.slice(0,5),sessionStorage.setItem(d.recentLocations,JSON.stringify(t.recentLocations))};t.selectDestination=function(n){console.log("selectDestination",n),e.destination=n,a.hide(),L(),t.loading=!0,h(n)},t.removeDestination=function(){console.log("removeDestination"),e.destination=!1,L(),t.loading=!0};var v=function(e){if(console.log("evaluateDepartureBoard"),void 0!==e&&e.hasOwnProperty("Departure")){var n=[];new Date;Array.isArray(e.Departure)||(e.Departure=[e.Departure]),e.Departure.forEach(function(e){switch(e.style={background:e.fgColor},e.type){case"VAS":e.icon="directions_subway";break;case"LDTRAIN":e.icon="directions_train";break;case"REGTRAIN":e.icon="train";break;default:e.icon=!1}e.rtFull=e.rtDate+"T"+e.rtTime,e.rt=new Date(e.rtFull),e.rt.setTime(e.rt.getTime()-72e5),e.st=new Date(e.date+"T"+e.time),e.st.setTime(e.st.getTime()-72e5);var t=e.direction.split("via");e.directionLine1=e.direction,e.direction.indexOf("via")>0&&(e.directionLine1=t[0].trim(),e.directionLine2=e.direction.replace(t[0],"").trim());var o=e.sname+e.direction,r=g(n,"id",o);r>-1?(departureBoardLine=n[r],departureBoardLine.departures.push(e)):n.push({id:o,departures:[e]})}),n.forEach(function(e){if(e.departures.length<u)for(var n=u-e.departures.length,o=n-1;o>=0;o--)e.departures.push({empty:!0});e.inTripLegs=!1,t.legs&&t.legs.forEach(function(t){if("WALK"!==t.type){var n=t.sname+t.direction;n===e.id&&(console.log("match"),e.inTripLegs=!0)}})}),t.departureBoardLines=n}else t.departureBoardLines=void 0};t.$watch("departureBoard",v);var L=function(){var o=l+"/departureBoard",r=l+"/trip",a=new Date;departureBoardParams={format:"json",useVas:1,useLDTrain:1,useRegTrain:1,useBus:1,useBoat:1,useTram:1,id:e.origin.id,date:a.toLocaleDateString("sv-SE").slice(0,10),time:a.getHours()+":"+a.getMinutes(),maxDeparturesPerLine:u,timeSpan:370},n.get(o,{params:departureBoardParams}).then(function(e){e&&e.data&&e.data.DepartureBoard&&(e.data.DepartureBoard.localVersion=Math.random(6),t.departureBoard=e.data.DepartureBoard,v(t.departureBoard)),t.loading=!1}),e.destination&&(tripParams={format:"json",useVas:1,useLDTrain:1,useRegTrain:1,useBus:1,useBoat:1,useTram:1,originId:e.origin.id,date:a.toLocaleDateString("sv-SE").slice(0,10),time:a.getHours()+":"+a.getMinutes(),destId:e.destination.id},n.get(r,{params:tripParams}).then(function(t){t&&t.data&&t.data&&(e.trips=t.data.TripList.Trip),console.log("trips",t.data.TripList.Trip)}))},D=function(){var e=l+"/location.name";new Date;params={format:"json",input:t.searchQuery},n.get(e,{params:params}).then(function(e){e&&e.data&&(t.locations=e.data),console.log("location.name",e.data),console.log(t.locations),t.loading=!1})}}]).directive("minutesUntil",["$interval",function(e){return{restrict:"E",link:function(t,n,o){function r(){var e=new Date;i.minutesUntil=Math.round((i.rt.getTime()-e.getTime())/60/1e3);var t=i.minutesUntil<60?i.minutesUntil:Math.round(i.minutesUntil/60)+"h";i.difference=(i.rt.getTime()-i.st.getTime())/60/1e3,0!==i.difference&&(t+=" <span class='difference'>("+i.difference+")</span>"),i.minutesUntil<1&&(t="Nu"),i.minutesUntil<0&&(t="Ã–ver"),n.html(t)}var a,i=t.departure;i.empty===!0?i.minutesUntil=!1:(a=e(r,1e4),r()),n.on("$destroy",function(){e.cancel(a)})}}}]);