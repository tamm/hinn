angular.module("Hinn",["ngMaterial","ngMdIcons","oauth2","angularMoment"]).config(["OAuthProvider",function(e){e.configure({baseUrl:"https://api.vasttrafik.se:443",clientId:"Hinn Med",clientKey:"9L4HY9Ofdsg4Q4JIbXY_2ugqVr8a",clientSecret:"NtG5cvDFKasC1NyDtGl9boyRfMYa",grantPath:"/token"})}]).run(["$rootScope","$window","OAuth","$mdToast",function(e,t,n,o){e.$on("oauth:error",function(t,r){if(console.log("caught an error",r),"invalid_grant"!==r.data.error)return"invalid_token"===r.data.error?(console.log("invalid_token"),e.token=n.getAccessToken(),e.loading=!1,o.show(o.simple().textContent("Please try that again.").position({bottom:!0}).hideDelay(3e3)),e.token):void 0})}]).controller("HinnController",["$rootScope","$scope","$http","OAuth","OAuthToken","$mdDialog","$interval","$timeout",function(e,t,n,o,r,a,i,s){var c="https://api.vasttrafik.se/bin/rest.exe/v2",l=(o.isAuthenticated(),4),u={};u.recentLocations="hinn.recentLocations",t.recentLocations=JSON.parse(sessionStorage.getItem(u.recentLocations))||[];var d=function(e,t,n){for(var o=0;o<e.length;o+=1)if(e[o][t]&&e[o][t]===n)return o;return-1};e.loading=!0,t.title="Hinn",t.$watch("NearbyStops",function(e){if(e){var n=[];e.LocationList.StopLocation.forEach(function(e){e.hasOwnProperty("track")||n.push(e)}),t.nearbystops=n}}),t.$watch("trips",function(e){if(e){var n=[];e.forEach(function(e){Array.isArray(e.Leg)||(e.Leg=[e.Leg]),n=n.concat(e.Leg)}),t.legs=n,h(t.departureBoard)}}),navigator.geolocation.getCurrentPosition(function(e){t.location=e,g()});var g=function(){var o=c+"/location.nearbystops";params={format:"json",originCoordLong:t.location.coords.longitude,originCoordLat:t.location.coords.latitude,maxNo:25},n.get(o,{params:params}).then(function(n){t.NearbyStops=n.data,console.log("nearbystops",t.NearbyStops),e.loading=!1})},p=function(){console.log("handleToken"),e.token=o.getAccessToken(),e.token.then(function(e){refreshTime=e.expiresAt-(new Date).getTime()-100,s(p,refreshTime)})};e.token=o.getAccessToken(),e.token.then(function(e){refreshTime=e.expiresAt-(new Date).getTime()-100,s(p,refreshTime)}),t.people=[{name:"tamm"},{name:"tamm2"}];var m=function(){var e=c+"/systeminfo";params={format:"json"},n.get(e,{params:params}).then(function(e){e&&e.data&&e.data.SystemInfo&&(t.SystemInfo=e.data.SystemInfo),console.log("systemInfo",e.data.SystemInfo)})};t.showInfo=function(e){console.log("showInfo"),m(),a.show({controller:"HinnController",templateUrl:"showInfoDialog.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:t.customFullscreen})},t.openSelectDestination=function(e){console.log("openSelectDestination"),a.show({controller:"HinnController",templateUrl:"selectDestination.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:!0})},t.openSelectOrigin=function(e){console.log("openSelectOrigin"),a.show({controller:"HinnController",templateUrl:"selectOrigin.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:!0})},t.selectOrigin=function(t){console.log("selectOrigin"),e.origin=t,v(),i.cancel(e.getDeparturesInterval),e.getDeparturesInterval=i(v,6e4),e.loading=!0,f(t),a.hide()},t.removeOrigin=function(){console.log("removeOrigin"),e.origin=!1,t.departureBoard=!1,i.cancel(e.getDeparturesInterval)},t.selectDeparture=function(e){console.log("selectDeparture"),t.departure=e},t.removeDeparture=function(){console.log("removeDeparture"),t.departure=!1},t.searchLocations=function(t){e.loading=!0,D()},t.closeDialog=function(){a.hide()};var f=function(e){console.log("saveRecentLocation"),t.recentLocations=JSON.parse(sessionStorage.getItem(u.recentLocations))||[],t.recentLocations.forEach(function(n,o){n&&n.id===e.id&&t.recentLocations.splice(o,1)}),t.recentLocations.unshift(e),t.recentLocations=t.recentLocations.slice(0,5),sessionStorage.setItem(u.recentLocations,JSON.stringify(t.recentLocations))};t.selectDestination=function(t){console.log("selectDestination",t),e.destination=t,a.hide(),v(),e.loading=!0,f(t)},t.removeDestination=function(){console.log("removeDestination"),e.destination=!1,v(),e.loading=!0};var h=function(n){if(console.log("evaluateDepartureBoard"),void 0!==n&&n.hasOwnProperty("Departure")){var o=[];new Date;Array.isArray(n.Departure)||(n.Departure=[n.Departure]),n.Departure.forEach(function(e){switch(e.style={background:e.fgColor,color:e.bgColor},e.type){case"VAS":e.icon="directions_subway";break;case"LDTRAIN":e.icon="directions_train";break;case"REGTRAIN":e.icon="train";break;default:e.icon=!1}e.rtFull=e.rtDate+"T"+e.rtTime,e.rt=new Date(e.rtFull),e.rt.setTime(e.rt.getTime()-72e5),e.st=new Date(e.date+"T"+e.time),e.st.setTime(e.st.getTime()-72e5);var t=e.direction.split("via");e.directionLine1=e.direction,e.direction.indexOf("via")>0&&(e.directionLine1=t[0].trim(),e.directionLine2=e.direction.replace(t[0],"").trim());var n=e.sname+e.direction,r=d(o,"id",n);r>-1?(departureBoardLine=o[r],departureBoardLine.departures.push(e)):o.push({id:n,departures:[e]})}),o.forEach(function(e){if(e.departures.length<l)for(var n=l-e.departures.length,o=n-1;o>=0;o--)e.departures.push({empty:!0});e.inTripLegs=!1,t.legs&&t.legs.forEach(function(t){if("WALK"!==t.type){var n=t.sname+t.direction;n===e.id&&(console.log("match"),e.inTripLegs=!0)}})}),e.departureBoardLines=o}else e.departureBoardLines=void 0};t.$watch("departureBoard",h);var v=function(){var o=c+"/departureBoard",r=c+"/trip",a=new Date;departureBoardParams={format:"json",useVas:1,useLDTrain:1,useRegTrain:1,useBus:1,useBoat:1,useTram:1,id:e.origin.id,date:a.toLocaleDateString("sv-SE").slice(0,10),time:a.getHours()+":"+a.getMinutes(),maxDeparturesPerLine:l,timeSpan:370},n.get(o,{params:departureBoardParams}).then(function(n){n&&n.data&&n.data.DepartureBoard&&(n.data.DepartureBoard.localVersion=Math.random(6),t.departureBoard=n.data.DepartureBoard),console.log(t.departureBoard),e.loading=!1}),e.destination&&(tripParams={format:"json",useVas:1,useLDTrain:1,useRegTrain:1,useBus:1,useBoat:1,useTram:1,originId:e.origin.id,date:a.toLocaleDateString("sv-SE").slice(0,10),time:a.getHours()+":"+a.getMinutes(),destId:e.destination.id},n.get(r,{params:tripParams}).then(function(t){t&&t.data&&t.data&&(e.trips=t.data.TripList.Trip),console.log("trips",t.data.TripList.Trip)}))},D=function(){var o=c+"/location.name";new Date;params={format:"json",input:t.searchQuery},n.get(o,{params:params}).then(function(n){n&&n.data&&(t.locations=n.data),console.log("location.name",n.data),console.log(t.locations),e.loading=!1})}}]).directive("minutesUntil",["$interval",function(e){return{restrict:"E",link:function(t,n,o){function r(){var e=new Date;i.minutesUntil=Math.round((i.rt.getTime()-e.getTime())/60/1e3);var t=i.minutesUntil<60?i.minutesUntil:Math.round(i.minutesUntil/60)+"h";i.difference=(i.rt.getTime()-i.st.getTime())/60/1e3,0!==i.difference&&(t+=" <span class='difference'>("+i.difference+")</span>"),i.minutesUntil<1&&(t="Nu"),i.minutesUntil<0&&(t="Ã…kt"),n.html(t)}var a,i=t.departure;i.empty===!0?i.minutesUntil=!1:(a=e(r,1e4),r()),n.on("$destroy",function(){e.cancel(a)})}}}]);