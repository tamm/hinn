angular.module("Hinn",["ngMaterial","ngMdIcons","oauth2","angularMoment"]).config(["OAuthProvider",function(e){e.configure({baseUrl:"https://api.vasttrafik.se:443",clientId:"Hinn Med",clientKey:"9L4HY9Ofdsg4Q4JIbXY_2ugqVr8a",clientSecret:"NtG5cvDFKasC1NyDtGl9boyRfMYa",grantPath:"/token"})}]).run(["$rootScope","$window","OAuth","$mdToast",function(e,t,n,o){e.$on("oauth:error",function(t,a){if(console.log("caught an error",a),"invalid_grant"!==a.data.error)return"invalid_token"===a.data.error?(console.log("invalid_token"),e.token=n.getAccessToken(),e.loading=!1,o.show(o.simple().textContent("Please try that again.").position({bottom:!0}).hideDelay(3e3)),e.token):void 0})}]).controller("HinnController",["$rootScope","$scope","$http","OAuth","OAuthToken","$mdDialog","$q","$interval","$timeout","$mdToast",function(e,t,n,o,a,r,i,s,c,l){var u="https://api.vasttrafik.se/bin/rest.exe/v2",d=(o.isAuthenticated(),4),g={};g.recentLocations="hinn.recentLocations",e.recentLocations=JSON.parse(localStorage.getItem(g.recentLocations))||[];var p=function(e,t,n){for(var o=0;o<e.length;o+=1)if(e[o][t]&&e[o][t]===n)return o;return-1};e.loading=!0,e.loadingText="Loading",t.title="Hinn",t.$watch("NearbyStops",function(n){if(n&&n.LocationList&&n.LocationList.StopLocation){var o=[];n.LocationList.StopLocation.forEach(function(t){if(!t.hasOwnProperty("track")){var n=p(e.recentLocations,"id",t.id),a=!1;n>=0&&(a=e.recentLocations[n]),a&&(t=a),o.push(t)}}),t.nearbyStops=o}else t.nearbyStops=[],t.nearbyStopsStatus=o}),t.$watch("trips",function(e){if(e){var n=[];e.forEach(function(e,t){Array.isArray(e.Leg)||(e.Leg=[e.Leg]),e.name="Trip "+t,e.Origin=e.Leg[0].Origin,e.Origin.tFull=new Date(e.Origin.date+"T"+e.Origin.time),e.Origin.tFull.setTime(e.Origin.tFull.getTime()-72e5),e.Destination=e.Leg[e.Leg.length-1].Destination,e.Destination.tFull=new Date(e.Destination.date+"T"+e.Destination.time),e.Destination.tFull.setTime(e.Destination.tFull.getTime()-72e5),e.duration=Math.round((e.Destination.tFull.getTime()-e.Origin.tFull.getTime())/60/1e3),n=n.concat(e.Leg)}),t.legs=n,L(t.departureBoard)}}),navigator.geolocation.getCurrentPosition(function(e){t.location=e,f()},function(t){console.log("failed to get location",t),l.show(l.simple().textContent(t.message).position({bottom:!0}).hideDelay(3e3)),e.loading=!1,console.log("loading: ",e.loading)});var f=function(){var o=u+"/location.nearbystops";params={format:"json",originCoordLong:t.location.coords.longitude,originCoordLat:t.location.coords.latitude,maxNo:25},n.get(o,{params:params}).then(function(n){t.NearbyStops=n.data,console.log("nearbystops",t.NearbyStops),e.loading=!1})},m=function(){console.log("handleToken"),e.token=o.getAccessToken(),e.token.then(function(e){refreshTime=e.expiresAt-(new Date).getTime()-100,c(m,refreshTime)})};e.token=o.getAccessToken(),e.token.then(function(e){refreshTime=e.expiresAt-(new Date).getTime()-100,c(m,refreshTime)}),t.people=[{name:"tamm"},{name:"tamm2"}];var h=function(){var t=u+"/systeminfo";params={format:"json"},n.get(t,{params:params}).then(function(t){t&&t.data&&t.data.SystemInfo&&(e.SystemInfo=t.data.SystemInfo),console.log("systemInfo",t.data.SystemInfo)})};t.showInfo=function(e){console.log("showInfo"),h(),r.show({controller:"HinnController",templateUrl:"showInfoDialog.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:t.customFullscreen})},t.openSelectDestination=function(e){console.log("openSelectDestination"),r.show({controller:"HinnController",templateUrl:"selectDestination.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:!0})},t.openSelectOrigin=function(e){console.log("openSelectOrigin"),r.show({controller:"HinnController",templateUrl:"selectOrigin.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:!0})},t.selectOrigin=function(t){console.log("selectOrigin"),e.origin=t,s.cancel(e.getDeparturesInterval),y(t),e.loading=!0,w().then(function(){e.getDeparturesInterval=s(w,6e4),r.hide()})},t.removeOrigin=function(){console.log("removeOrigin"),e.origin=!1,t.departureBoard=!1,s.cancel(e.getDeparturesInterval)},t.selectDeparture=function(e){console.log("selectDeparture"),t.departure=e},t.removeDeparture=function(){console.log("removeDeparture"),t.departure=!1},t.searchLocations=function(t){e.loading=!0,S()},e.closeDialog=function(){console.log("close mdDialog"),r.hide()};var D=function(e){return e*(Math.PI/180)},v=function(e,t,n,o){var a=6371,r=D(n-e),i=D(o-t),s=Math.sin(r/2)*Math.sin(r/2)+Math.cos(D(e))*Math.cos(D(n))*Math.sin(i/2)*Math.sin(i/2),c=2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)),l=a*c;return l},T=function(e,t){return e&&t?(e.coords&&(e.lat=e.coords.latitude,e.lon=e.coords.longitude),t.coords&&(t.lat=t.coords.latitude,t.lon=t.coords.longitude),v(e.lat,e.lon,t.lat,t.lon)):null},y=function(n){console.log("saveRecentLocation"),e.recentLocations=JSON.parse(localStorage.getItem(g.recentLocations))||[],n.chosen=[{time:new Date,location:t.location,distance:T(t.location,n)}];var o=!1;e.recentLocations.forEach(function(t,a){t&&t.id===n.id&&(o=e.recentLocations.splice(a,1)[0])}),o&&(n.chosen=n.chosen.concat(o.chosen)),n.choiceDistanceTotal=!1,n.choiceDistances=0,n.chosen&&(n.chosen.forEach(function(e){void 0!==e.distance&&null!==e.distance&&(n.choiceDistanceTotal+=e.distance,n.choiceDistances+=1)}),n.choiceDistance=Math.round(n.choiceDistanceTotal/n.choiceDistances*100)/100),e.recentLocations.unshift(n),console.log("recentLocations",e.recentLocations),localStorage.setItem(g.recentLocations,JSON.stringify(e.recentLocations))};t.selectDestination=function(t){console.log("selectDestination",t),e.destination=t,r.hide(),w(),e.loading=!0,y(t)},t.removeDestination=function(){console.log("removeDestination"),e.destination=!1,w(),e.loading=!0};var L=function(n){if(console.log("evaluateDepartureBoard"),void 0!==n&&n.hasOwnProperty("Departure")){var o=[],a=new Date;e.departureBoardTotalDelay=0,e.departureBoardDelays=0,e.departureBoardAverageDelay=0,Array.isArray(n.Departure)||(n.Departure=[n.Departure]),n.Departure.forEach(function(t){switch(t.style={background:t.fgColor,color:t.bgColor},t.type){case"BUS":isNaN(t.sname)&&(t.icon="directions_bus"),t.showIcon=!1;break;case"VAS":t.icon="directions_subway",t.showIcon=!0;break;case"LDTRAIN":t.icon="directions_train",t.showIcon=!0;break;case"REGTRAIN":t.icon="train",t.showIcon=!0;break;default:t.icon=!1,t.showIcon=!1}t.rtFull=void 0!==t.rtDate?t.rtDate+"T"+t.rtTime:t.date+"T"+t.time,t.rt=new Date(t.rtFull),t.rt.setTime(t.rt.getTime()-36e5),t.st=new Date(t.date+"T"+t.time),t.st.setTime(t.st.getTime()-36e5),t.difference=(t.rt.getTime()-t.st.getTime())/60/1e3,t.minutesUntil=Math.round((t.rt.getTime()-a.getTime())/60/1e3),t.delayAverage=t.difference?t.difference:0,t.difference>0&&(e.departureBoardTotalDelay+=t.difference,e.departureBoardDelays+=1);var n=t.direction.split("via");t.directionLine1=t.direction,t.direction.indexOf("via")>0&&(t.directionLine1=n[0].trim(),t.directionLine2=t.direction.replace(n[0],"").trim());var r=t.sname+t.direction,i={id:r,departures:[t],trips:[]},s=p(o,"id",r);s>-1?(i=o[s],i.departures.push(t)):o.push(i),i.totalDelay=0,i.numberOfDelayedDepartures=0,i.departures.forEach(function(e){0!==e.difference&&(i.totalDelay+=e.difference,i.numberOfDelayedDepartures+=1)}),i.delayAverage=0!==i.totalDelay?Math.round(i.totalDelay/i.numberOfDelayedDepartures):0}),e.departureBoardAverageDelay=Math.round(e.departureBoardTotalDelay/e.departureBoardDelays),o.forEach(function(e){if(e.departures.length<d)for(var n=d-e.departures.length,o=n-1;o>=0;o--)e.departures.push({empty:!0});e.inTripLegs=!1,t.trips&&t.trips.forEach(function(t){t.Leg.forEach(function(n){if("WALK"!==n.type){var o=n.sname+n.direction;o===e.id&&(console.log("match"),e.inTripLegs=!0,e.trips.push(t))}})})}),console.log("departureBoardLines",o),e.departureBoardLines=o}else e.departureBoardLines=void 0};t.$watch("departureBoard",L);var w=function(){var o=u+"/departureBoard",a=u+"/trip",r=new Date,s=i(function(i,s){departureBoardParams={format:"json",useVas:1,useLDTrain:1,useRegTrain:1,useBus:1,useBoat:1,useTram:1,id:e.origin.id,date:r.toLocaleDateString("sv-SE").slice(0,10),time:r.getHours()+":"+r.getMinutes(),maxDeparturesPerLine:d,timeSpan:370},n.get(o,{params:departureBoardParams}).then(function(n){n&&n.data&&n.data.DepartureBoard&&(n.data.DepartureBoard.localVersion=Math.random(6),t.departureBoard=n.data.DepartureBoard),console.log(t.departureBoard),e.loading=!1,i("Got departures")}),e.destination&&(tripParams={format:"json",useVas:1,useLDTrain:1,useRegTrain:1,useBus:1,useBoat:1,useTram:1,originId:e.origin.id,date:r.toLocaleDateString("sv-SE").slice(0,10),time:r.getHours()+":"+r.getMinutes(),destId:e.destination.id},n.get(a,{params:tripParams}).then(function(t){t&&t.data&&t.data&&(e.trips=t.data.TripList.Trip),console.log("trips",t.data.TripList.Trip),i("Got trips")}))});return s},S=function(){var o=u+"/location.name";new Date;params={format:"json",input:t.searchQuery},n.get(o,{params:params}).then(function(n){n&&n.data&&(t.locations=n.data),console.log("location.name",n.data),console.log(t.locations),e.loading=!1})}}]).directive("minutesUntil",["$interval",function(e){return{restrict:"E",link:function(t,n,o){function a(){var e=(new Date,i.minutesUntil<60?i.minutesUntil:Math.round(i.minutesUntil/60)+"h");0!==i.difference&&(e+=" <span class='difference'>("+i.difference+")</span>"),i.minutesUntil<1&&(e="Nu"),i.minutesUntil<0&&(e="Ã…kt"),n.html(e)}var r,i=t.departure;i.empty===!0?i.minutesUntil=!1:(r=e(a,1e4),a()),n.on("$destroy",function(){e.cancel(r)})}}}]);