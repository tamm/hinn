angular.module("HinnMed",["ngMaterial","ngMdIcons","oauth2","angularMoment"]).config(["OAuthProvider",function(e){e.configure({baseUrl:"https://api.vasttrafik.se:443",clientId:"Hinn Med",clientKey:"9L4HY9Ofdsg4Q4JIbXY_2ugqVr8a",clientSecret:"NtG5cvDFKasC1NyDtGl9boyRfMYa",grantPath:"/token"})}]).run(["$rootScope","$window","OAuth",function(e,t,r){e.$on("oauth:error",function(e,t){if("invalid_grant"!==t.data.error)return"invalid_token"===t.data.error?r.getRefreshToken():void 0})}]).controller("HinnMedController",["$scope","$http","OAuth","$mdDialog",function(e,t,r,a){var o="https://api.vasttrafik.se/bin/rest.exe/v2",n=(r.isAuthenticated(),r.getAccessToken()),i=2,s=function(e,t,r){for(var a=0;a<e.length;a+=1)if(e[a][t]&&e[a][t]===r)return a;return-1};e.loading=!0,e.title="Hinn Med",e.$watch("NearbyStops",function(t){if(t){var r=[];t.LocationList.StopLocation.forEach(function(e){e.hasOwnProperty("track")||r.push(e)}),e.nearbystops=r}}),navigator.geolocation.getCurrentPosition(function(t){e.location=t,c()});var c=function(){var r=o+"/location.nearbystops";params={format:"json",originCoordLong:e.location.coords.longitude,originCoordLat:e.location.coords.latitude,maxNo:25},t.get(r,{params:params}).then(function(t){e.NearbyStops=t.data,console.log("nearbystops",e.NearbyStops),e.loading=!1})};n.then(function(){var r=o+"/systeminfo";params={format:"json"},t.get(r,{params:params}).then(function(t){t&&t.data&&t.data.SystemInfo&&(e.SystemInfo=t.data.SystemInfo),console.log("systemInfo",t.data.SystemInfo)})}),e.people=[{name:"tamm"},{name:"tamm2"}],e.showInfo=function(t){console.log("showInfo"),a.show({controller:"HinnMedController",templateUrl:"showInfoDialog.html",parent:angular.element(document.body),targetEvent:t,clickOutsideToClose:!0,fullscreen:e.customFullscreen})},e.selectOrigin=function(t){console.log("selectOrigin",t),e.origin=t,d(t.id),e.loading=!0},e.removeOrigin=function(){console.log("removeOrigin"),e.origin=!1,e.departureBoard=!1},e.$watch("departureBoard",function(t){if(void 0!==t&&t.hasOwnProperty("Departure")){var r=[],a=new Date;t.Departure.forEach(function(e){switch(e.style={background:e.fgColor},e.type){case"BUS":isNaN(e.sname)&&(e.icon="directions_bus");break;case"VAS":e.icon="directions_subway";break;case"LDTRAIN":e.icon="directions_train";break;case"REGTRAIN":e.icon="train";break;case"BOAT":e.icon="directions_ferry";break;case"TRAM":e.icon="tram";break;default:e.icon=!1}e.rtFull=e.rtDate+"T"+e.rtTime;var t=new Date(e.rtFull);t.setTime(t.getTime()-72e5);var o=new Date(e.date+"T"+e.time);o.setTime(o.getTime()-72e5),e.difference=(t.getTime()-o.getTime())/60/1e3,e.minutesUntil=Math.round((t.getTime()-a.getTime())/60/1e3);var n=e.direction.split("via");e.directionLine1=e.direction,e.direction.indexOf("via")>0&&(e.directionLine1=n[0].trim(),e.directionLine2=e.direction.replace(n[0],"").trim());var i=e.sname+e.track+e.direction,c=s(r,"id",i);c>-1?(departureBoardLine=r[c],departureBoardLine.departures.push(e)):r.push({id:i,departures:[e]})}),r.forEach(function(e){if(e.departures.length<i)for(var t=i-e.departures.length,r=t-1;r>=0;r--)e.departures.push({empty:!0})}),e.departureBoardLines=r}else e.departureBoardLines=void 0});var d=function(r,a){var n=o+"/departureBoard",s=new Date;params={format:"json",useVas:1,useLDTrain:1,useRegTrain:1,useBus:1,useBoat:1,useTram:1,id:r,date:s.toLocaleDateString("sv-SE").slice(0,10),time:s.getHours()+":"+s.getMinutes(),maxDeparturesPerLine:i,timeSpan:70},console.log(params),a&&(params.direction=a),t.get(n,{params:params}).then(function(t){t&&t.data&&t.data.DepartureBoard&&(e.departureBoard=t.data.DepartureBoard),console.log("departureBoard",t.data.DepartureBoard),e.loading=!1})}}]);