angular.module("Hinn",["ngMaterial","ngMdIcons","oauth2","angularMoment"]).config(["OAuthProvider",function(e){e.configure({baseUrl:"https://api.vasttrafik.se:443",clientId:"Hinn Med",clientKey:"9L4HY9Ofdsg4Q4JIbXY_2ugqVr8a",clientSecret:"NtG5cvDFKasC1NyDtGl9boyRfMYa",grantPath:"/token"})}]).run(["$rootScope","$window","OAuth",function(e,t,n){console.log("set up error handling"),e.$on("oauth:error",function(e,t){if(console.log("caught an error",t),"invalid_grant"!==t.data.error)return"invalid_token"===t.data.error?(console.log("invalid_token"),n.getRefreshToken()):void 0})}]).controller("HinnController",["$scope","$http","OAuth","OAuthToken","$mdDialog","$interval","$timeout",function(e,t,n,r,o,a,i){var s,c="https://api.vasttrafik.se/bin/rest.exe/v2",u=(n.isAuthenticated(),2),l=function(e,t,n){for(var r=0;r<e.length;r+=1)if(e[r][t]&&e[r][t]===n)return r;return-1};e.loading=!0,e.title="Hinn",e.$watch("NearbyStops",function(t){if(t){var n=[];t.LocationList.StopLocation.forEach(function(e){e.hasOwnProperty("track")||n.push(e)}),e.nearbystops=n}}),navigator.geolocation.getCurrentPosition(function(t){e.location=t,d()});var d=function(){var n=c+"/location.nearbystops";params={format:"json",originCoordLong:e.location.coords.longitude,originCoordLat:e.location.coords.latitude,maxNo:25},t.get(n,{params:params}).then(function(t){e.NearbyStops=t.data,console.log("nearbystops",e.NearbyStops),e.loading=!1})},p=function(){console.log("handleToken"),e.token=n.getAccessToken(),e.token.then(function(e){refreshTime=e.expiresAt-(new Date).getTime()-100,i(p,refreshTime)})};e.token=n.getAccessToken(),e.token.then(function(n){refreshTime=n.expiresAt-(new Date).getTime()-100,i(p,refreshTime);var r=c+"/systeminfo";params={format:"json"},t.get(r,{params:params}).then(function(t){t&&t.data&&t.data.SystemInfo&&(e.SystemInfo=t.data.SystemInfo),console.log("systemInfo",t.data.SystemInfo)})}),e.people=[{name:"tamm"},{name:"tamm2"}],e.showInfo=function(t){console.log("showInfo"),o.show({controller:"HinnController",templateUrl:"showInfoDialog.html",parent:angular.element(document.body),targetEvent:t,clickOutsideToClose:!0,fullscreen:e.customFullscreen})},e.selectOrigin=function(t){console.log("selectOrigin",t),e.origin=t,f(),s=a(f,6e4),e.loading=!0},e.removeOrigin=function(){console.log("removeOrigin"),e.origin=!1,e.departureBoard=!1,a.cancel(s)},e.selectDeparture=function(t){console.log("selectDeparture",t.departures[0]),e.departure=t.departures[0]},e.removeDeparture=function(){console.log("removeDeparture"),e.departure=!1},e.$watch("departureBoard",function(t){if(void 0!==t&&t.hasOwnProperty("Departure")){var n=[];new Date;t.Departure.forEach(function(e){switch(e.style={background:e.fgColor},e.type){case"BUS":isNaN(e.sname)&&(e.icon="directions_bus");break;case"VAS":e.icon="directions_subway";break;case"LDTRAIN":e.icon="directions_train";break;case"REGTRAIN":e.icon="train";break;case"BOAT":e.icon="directions_ferry";break;case"TRAM":e.icon="tram";break;default:e.icon=!1}e.rtFull=e.rtDate+"T"+e.rtTime,e.rt=new Date(e.rtFull),e.rt.setTime(e.rt.getTime()-72e5),e.st=new Date(e.date+"T"+e.time),e.st.setTime(e.st.getTime()-72e5);var t=e.direction.split("via");e.directionLine1=e.direction,e.direction.indexOf("via")>0&&(e.directionLine1=t[0].trim(),e.directionLine2=e.direction.replace(t[0],"").trim());var r=e.sname+e.track+e.direction,o=l(n,"id",r);o>-1?(departureBoardLine=n[o],departureBoardLine.departures.push(e)):n.push({id:r,departures:[e]})}),n.forEach(function(e){if(e.departures.length<u)for(var t=u-e.departures.length,n=t-1;n>=0;n--)e.departures.push({empty:!0})}),e.departureBoardLines=n}else e.departureBoardLines=void 0});var f=function(){var n=c+"/departureBoard",r=new Date;params={format:"json",useVas:1,useLDTrain:1,useRegTrain:1,useBus:1,useBoat:1,useTram:1,id:e.origin.id,date:r.toLocaleDateString("sv-SE").slice(0,10),time:r.getHours()+":"+r.getMinutes(),maxDeparturesPerLine:u,timeSpan:70},console.log(params),e.destination&&(params.direction=e.destination.id),t.get(n,{params:params}).then(function(t){t&&t.data&&t.data.DepartureBoard&&(e.departureBoard=t.data.DepartureBoard),console.log("departureBoard",t.data.DepartureBoard),e.loading=!1})}}]).directive("minutesUntil",["$interval",function(e){return{restrict:"E",link:function(t,n,r){function o(){var e=new Date;i.minutesUntil=Math.round((i.rt.getTime()-e.getTime())/60/1e3);var t=i.minutesUntil;i.difference=(i.rt.getTime()-i.st.getTime())/60/1e3,0!==i.difference&&(t+=" <span class='difference'>("+i.difference+")</span>"),i.minutesUntil<1&&(t="Nu"),n.html(t)}var a,i=t.departure;i.empty===!0?i.minutesUntil=!1:(a=e(o,1e4),o()),n.on("$destroy",function(){e.cancel(a)})}}}]);