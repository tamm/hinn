angular.module("Hinn",["ngMaterial","ngMdIcons","oauth2","angularMoment"]).config(["OAuthProvider",function(e){e.configure({baseUrl:"https://api.vasttrafik.se:443",clientId:"Hinn Med",clientKey:"9L4HY9Ofdsg4Q4JIbXY_2ugqVr8a",clientSecret:"NtG5cvDFKasC1NyDtGl9boyRfMYa",grantPath:"/token"})}]).run(["$rootScope","$window","OAuth","$mdToast",function(e,t,n,o){e.$on("oauth:error",function(t,i){if(console.log("caught an error",i),"invalid_grant"!==i.data.error)return"invalid_token"===i.data.error?(console.log("invalid_token"),e.token=n.getAccessToken(),e.loading=!1,o.show(o.simple().textContent("Please try that again.").position({bottom:!0}).hideDelay(3e3)),e.token):void 0})}]).controller("HinnController",["$rootScope","$scope","$http","OAuth","OAuthToken","$mdDialog","$q","$interval","$timeout","$mdToast",function(e,t,n,o,i,a,r,s,c,l){var u="https://api.vasttrafik.se/bin/rest.exe/v2",d=(o.isAuthenticated(),4),g={};g.recentLocations="hinn.recentLocations",t.recentLocations=JSON.parse(sessionStorage.getItem(g.recentLocations))||[];var p=function(e,t,n){for(var o=0;o<e.length;o+=1)if(e[o][t]&&e[o][t]===n)return o;return-1};e.loading=!0,e.loadingText="Loading",t.title="Hinn",t.$watch("NearbyStops",function(e){if(e){var n=[];e.LocationList.StopLocation.forEach(function(e){e.hasOwnProperty("track")||n.push(e)}),t.nearbystops=n}}),t.$watch("trips",function(e){if(e){var n=[];e.forEach(function(e,t){Array.isArray(e.Leg)||(e.Leg=[e.Leg]),e.name="Trip "+t,e.Origin=e.Leg[0].Origin,e.Origin.tFull=new Date(e.Origin.date+"T"+e.Origin.time),e.Origin.tFull.setTime(e.Origin.tFull.getTime()-72e5),e.Destination=e.Leg[e.Leg.length-1].Destination,e.Destination.tFull=new Date(e.Destination.date+"T"+e.Destination.time),e.Destination.tFull.setTime(e.Destination.tFull.getTime()-72e5),e.duration=Math.round((e.Destination.tFull.getTime()-e.Origin.tFull.getTime())/60/1e3),n=n.concat(e.Leg)}),t.legs=n,v(t.departureBoard)}}),navigator.geolocation.getCurrentPosition(function(e){t.location=e,m()},function(t){console.log("failed to get location",t),l.show(l.simple().textContent(t.message).position({bottom:!0}).hideDelay(3e3)),e.loading=!1,console.log("loading: ",e.loading)});var m=function(){var o=u+"/location.nearbystops";params={format:"json",originCoordLong:t.location.coords.longitude,originCoordLat:t.location.coords.latitude,maxNo:25},n.get(o,{params:params}).then(function(n){t.NearbyStops=n.data,console.log("nearbystops",t.NearbyStops),e.loading=!1})},f=function(){console.log("handleToken"),e.token=o.getAccessToken(),e.token.then(function(e){refreshTime=e.expiresAt-(new Date).getTime()-100,c(f,refreshTime)})};e.token=o.getAccessToken(),e.token.then(function(e){refreshTime=e.expiresAt-(new Date).getTime()-100,c(f,refreshTime)}),t.people=[{name:"tamm"},{name:"tamm2"}];var h=function(){var t=u+"/systeminfo";params={format:"json"},n.get(t,{params:params}).then(function(t){t&&t.data&&t.data.SystemInfo&&(e.SystemInfo=t.data.SystemInfo),console.log("systemInfo",t.data.SystemInfo)})};t.showInfo=function(e){console.log("showInfo"),h(),a.show({controller:"HinnController",templateUrl:"showInfoDialog.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:t.customFullscreen})},t.openSelectDestination=function(e){console.log("openSelectDestination"),a.show({controller:"HinnController",templateUrl:"selectDestination.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:!0})},t.openSelectOrigin=function(e){console.log("openSelectOrigin"),a.show({controller:"HinnController",templateUrl:"selectOrigin.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:!0})},t.selectOrigin=function(t){console.log("selectOrigin"),e.origin=t,s.cancel(e.getDeparturesInterval),D(t),e.loading=!0,T().then(function(){e.getDeparturesInterval=s(T,6e4),a.hide()})},t.removeOrigin=function(){console.log("removeOrigin"),e.origin=!1,t.departureBoard=!1,s.cancel(e.getDeparturesInterval)},t.selectDeparture=function(e){console.log("selectDeparture"),t.departure=e},t.removeDeparture=function(){console.log("removeDeparture"),t.departure=!1},t.searchLocations=function(t){e.loading=!0,L()},e.closeDialog=function(){a.hide()};var D=function(e){console.log("saveRecentLocation"),t.recentLocations=JSON.parse(sessionStorage.getItem(g.recentLocations))||[],t.recentLocations.forEach(function(n,o){n&&n.id===e.id&&t.recentLocations.splice(o,1)}),t.recentLocations.unshift(e),t.recentLocations=t.recentLocations.slice(0,5),sessionStorage.setItem(g.recentLocations,JSON.stringify(t.recentLocations))};t.selectDestination=function(t){console.log("selectDestination",t),e.destination=t,a.hide(),T(),e.loading=!0,D(t)},t.removeDestination=function(){console.log("removeDestination"),e.destination=!1,T(),e.loading=!0};var v=function(n){if(console.log("evaluateDepartureBoard"),void 0!==n&&n.hasOwnProperty("Departure")){var o=[],i=new Date,a=0,r=0;Array.isArray(n.Departure)||(n.Departure=[n.Departure]),n.Departure.forEach(function(e){switch(e.style={background:e.fgColor,color:e.bgColor},e.type){case"BUS":isNaN(e.sname)&&(e.icon="directions_bus"),e.showIcon=!1;break;case"VAS":e.icon="directions_subway",e.showIcon=!0;break;case"LDTRAIN":e.icon="directions_train",e.showIcon=!0;break;case"REGTRAIN":e.icon="train",e.showIcon=!0;break;default:e.icon=!1,e.showIcon=!1}e.rtFull=void 0!==e.rtDate?e.rtDate+"T"+e.rtTime:e.date+"T"+e.time,e.rt=new Date(e.rtFull),e.rt.setTime(e.rt.getTime()-72e5),e.st=new Date(e.date+"T"+e.time),e.st.setTime(e.st.getTime()-72e5),e.difference=(e.rt.getTime()-e.st.getTime())/60/1e3,e.minutesUntil=Math.round((e.rt.getTime()-i.getTime())/60/1e3),e.delayAverage=e.difference?e.difference:0,e.difference>0&&(a+=e.difference,r+=1);var t=e.direction.split("via");e.directionLine1=e.direction,e.direction.indexOf("via")>0&&(e.directionLine1=t[0].trim(),e.directionLine2=e.direction.replace(t[0],"").trim());var n=e.sname+e.direction,s={id:n,departures:[e],trips:[]},c=p(o,"id",n);c>-1?(s=o[c],s.departures.push(e)):o.push(s),s.totalDelay=0,s.departures.forEach(function(e){s.totalDelay+=e.difference}),s.delayAverage=s.totalDelay/s.departures.length}),console.log("departureBoardTotalDelay",a,r,a/r),o.forEach(function(e){if(e.departures.length<d)for(var n=d-e.departures.length,o=n-1;o>=0;o--)e.departures.push({empty:!0});e.inTripLegs=!1,t.trips&&t.trips.forEach(function(t){t.Leg.forEach(function(n){if("WALK"!==n.type){var o=n.sname+n.direction;o===e.id&&(console.log("match"),e.inTripLegs=!0,e.trips.push(t))}})})}),console.log("departureBoardLines",o),e.departureBoardLines=o}else e.departureBoardLines=void 0};t.$watch("departureBoard",v);var T=function(){var o=u+"/departureBoard",i=u+"/trip",a=new Date,s=r(function(r,s){departureBoardParams={format:"json",useVas:1,useLDTrain:1,useRegTrain:1,useBus:1,useBoat:1,useTram:1,id:e.origin.id,date:a.toLocaleDateString("sv-SE").slice(0,10),time:a.getHours()+":"+a.getMinutes(),maxDeparturesPerLine:d,timeSpan:370},n.get(o,{params:departureBoardParams}).then(function(n){n&&n.data&&n.data.DepartureBoard&&(n.data.DepartureBoard.localVersion=Math.random(6),t.departureBoard=n.data.DepartureBoard),console.log(t.departureBoard),e.loading=!1,r("Got departures")}),e.destination&&(tripParams={format:"json",useVas:1,useLDTrain:1,useRegTrain:1,useBus:1,useBoat:1,useTram:1,originId:e.origin.id,date:a.toLocaleDateString("sv-SE").slice(0,10),time:a.getHours()+":"+a.getMinutes(),destId:e.destination.id},n.get(i,{params:tripParams}).then(function(t){t&&t.data&&t.data&&(e.trips=t.data.TripList.Trip),console.log("trips",t.data.TripList.Trip),r("Got trips")}))});return s},L=function(){var o=u+"/location.name";new Date;params={format:"json",input:t.searchQuery},n.get(o,{params:params}).then(function(n){n&&n.data&&(t.locations=n.data),console.log("location.name",n.data),console.log(t.locations),e.loading=!1})}}]).directive("minutesUntil",["$interval",function(e){return{restrict:"E",link:function(t,n,o){function i(){var e=(new Date,r.minutesUntil<60?r.minutesUntil:Math.round(r.minutesUntil/60)+"h");0!==r.difference&&(e+=" <span class='difference'>("+r.difference+")</span>"),r.minutesUntil<1&&(e="Nu"),r.minutesUntil<0&&(e="Ã…kt"),n.html(e)}var a,r=t.departure;r.empty===!0?r.minutesUntil=!1:(a=e(i,1e4),i()),n.on("$destroy",function(){e.cancel(a)})}}}]);